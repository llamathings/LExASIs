<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ConvoSniffer - dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous">
    <script type="importmap">
      {
        "imports": {
          "preact": "https://esm.sh/preact@10.23.1",
          "preact/": "https://esm.sh/preact@10.23.1/",
          "@preact/signals": "https://esm.sh/@preact/signals@1.3.0?external=preact",
          "htm/preact": "https://esm.sh/htm@3.1.1/preact?external=preact"
        }
      }
    </script>
  </head>
  <body>
    <div id="app"></div>
    <script type="module">
      import { render } from 'preact';
      import { useEffect, useState } from 'preact/hooks';
      import { html } from 'htm/preact';

      export function App() {
        const [socket, setSocket] = useState();
        const [convo, setConvo] = useState(false)
        const [replies, setReplies] = useState([]);
        const [keybinds, setKeybinds] = useState([]);

        useEffect(() => {
          const socket = new WebSocket("ws://" + location.host + "/socket");

          socket.onopen = (event) => {
            console.log("Socket open...");
          };

          socket.onmessage = (event) => {
            const message = JSON.parse(event.data);
            const [key, value] = Object.entries(message)[0];

            // console.log(key);
            // console.log(value);

            if (key == "Conversation") {
              setConvo(value.start);
              setReplies([]);
            } else if (key == "UpdateReplies") {
              setReplies(value.replies);
            } else if (key == "QueueReply") {
              setReplies((_replies) =>
                _replies.map((reply, index) => {
                  if (index === value.index) {
                    return { ...reply, queued: true };
                  }
                  return { ...reply, queued: false };
                })
              );
            } else if (key == "SetKeybinds") {
              setKeybinds(value.keybinds);
            } else {
              console.log("unknown ws key: ", key);
              setConvo(false);
              setReplies([]);
            }
          };

          socket.onerror = (event) => {
            console.log("Socket error...");
            setConvo(false);
            setReplies([]);
          };

          setSocket(socket);
          return () => socket.close();
        }, []);

        let contents;
        if (convo === false) {
          contents = html`
            <div class="row">
              <div class="col">
                <p class="lead">Not in conversation.</p>
              </div>
            </div>
          `;
        } else {
          contents = replies
            .filter(reply => !(reply.id === 0 && reply.paraphrase == "" && reply.text == ""))
            .map(reply => {
              return html`
                <div class="row align-items-center rounded py-1 mb-2 ${(reply.queued === true ? "text-success bg-success-subtle" : "")}">
                  <div class="col-auto text-center">
                    <kbd class="fw-bold ${(reply.queued === true ? "bg-success" : "")}">
                      ${reply.id < keybinds.length ? keybinds[reply.id] : "??"}
                    </kbd>
                  </div>
                  <div class="col">
                    <div class="row">
                      <div class="col"><strong>${reply.paraphrase}</strong></div>
                    </div>
                    <div class="row">
                      <div class="col"><small><em>${reply.text}</em></small></div>
                    </div>
                  </div>
                </div>
              `;
            });

            if (!Array.isArray(contents) || !contents.length) {
              contents = html`
                <div class="row">
                  <div class="col">
                    <p class="lead">No valid replies.</p>
                  </div>
                </div>
              `;
            }
        }

        return html`
            <div class="container">
              <div class="row mt-3 mb-2">
                <div class="col">
                  <h2 class="pb-1 border-bottom">Active conversation:</h2>
                </div>
              </div>
              ${contents}
            </div>
          `;
      }

      render(html`<${App} />`, document.getElementById('app'));
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js" integrity="sha384-j1CDi7MgGQ12Z7Qab0qlWQ/Qqz24Gc6BM0thvEMVjHnfYGF0rmFCozFSxQBxwHKO" crossorigin="anonymous"></script>
  </body>
</html>
