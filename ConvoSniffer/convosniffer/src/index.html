<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ConvoSniffer - dashboard</title>
    <link rel="stylesheet" href="https://unpkg.com/normalize.css@8.0.1/normalize.css">
    <style>
      body {
        background-color: lightgray;
        font-family: sans-serif;
        font-size: 18px;
        padding: 1em;
      }
    </style>
    <script type="importmap">
      {
        "imports": {
          "preact": "https://esm.sh/preact@10.23.1",
          "preact/": "https://esm.sh/preact@10.23.1/",
          "@preact/signals": "https://esm.sh/@preact/signals@1.3.0?external=preact",
          "htm/preact": "https://esm.sh/htm@3.1.1/preact?external=preact"
        }
      }
    </script>
  </head>
  <body>
    <div id="app"></div>
    <script type="module">
      import { render } from 'preact';
      import { useEffect, useState } from 'preact/hooks';
      import { html } from 'htm/preact';

      export function App() {
        const [socket, setSocket] = useState();
        const [convo, setConvo] = useState(false)
        const [replies, setReplies] = useState([]);
        const [keybinds, setKeybinds] = useState([]);

        useEffect(() => {
          const socket = new WebSocket("ws://" + location.host + "/socket");

          socket.onopen = (event) => {
            console.log("Socket open...");
          };

          socket.onmessage = (event) => {
            const message = JSON.parse(event.data);
            const [key, value] = Object.entries(message)[0];

            console.log(key);
            console.log(value);

            if (key == "Conversation") {
              setConvo(value.start);
              setReplies([]);
              setKeybinds([]);
            } else if (key == "UpdateReplies") {
              setReplies(value.replies);
            } else if (key == "SetKeybinds") {
              setKeybinds(value.keybinds);
            } else {
              console.log("unknown ws key: ", key);
              setConvo(false);
              setReplies([]);
              setKeybinds([]);
            }
          };

          socket.onerror = (event) => {
            console.log("Socket error...");
            setConvo(false);
            setReplies([]);
            setKeybinds([]);
          };

          setSocket(socket);
          return () => socket.close();
        }, []);

        if (convo === false) {
          return html`<span>(No conversation.)</span>`;
        } else {
          let replyBlocks = replies
            .filter(reply => !(reply.id === 0 && reply.paraphrase == "" && reply.text == ""))
            .map(reply => html`<div><strong>${reply.id < keybinds.length ? keybinds[reply.id] : "???"}.</strong> ${reply.paraphrase} <em>(${reply.text})</em></div>`);

          return html`
            <div>
              <header>Conversation active:</header>
              <hr/>
              ${replyBlocks}
            </div>
          `;
        }
      }

      render(html`<${App} />`, document.getElementById('app'));
    </script>
  </body>
</html>
